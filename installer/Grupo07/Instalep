#!/bin/bash
GRUPO=$(pwd)
DIRCONF="dirconf"
CONF_FILE="$GRUPO/$DIRCONF/Instalep.conf"
# Check if already installed
if [ -f $CONF_FILE ]; then
  echo -e "###\tEl sistema EPLAM ya se encuentra instalado\t###\n"
  exit 0
fi

# Set directory default values
DIRBIN="bin"
DIRMAE="mae"
DIRREC="nov"
DIROK="ok"
DIRPROC="imp"
DIRINFO="rep"
DIRLOG="log"
DIRNOK="nok"
VALID="N"

# Updates reserved values list
update_reserved() {
  RESERVED="$DIRBIN $DIRMAE $DIRREC $DIROK $DIRPROC $DIRINFO $DIRLOG $DIRNOK" 
}

request_dirpath() {
  update_reserved
  local VALID="N"  
  while [ $VALID == "N" ]; do
    ## Prompt for exec directory
    read -p "$1" UINPUT 
    ## Validate user input
    if [ ! -z "$UINPUT" -a "$UINPUT" != " " ]; then
      VALID="Y"
      for rname in $RESERVED; do
	if [ $UINPUT == $rname ]; then
	  echo -e "\n# El nombre $UINPUT se encuentra reservado\n" >&2
	  VALID="N"
	  break
	fi
      done
      ## If name not reserved
      if [ $VALID == "Y" ]; then
        echo "$UINPUT"
      fi
    else
      VALID="Y"
      echo "$2"
    fi
  done
}

update_reserved
CONTINUE="N"
while [ $CONTINUE != "S" ]; do
clear
echo -e "###\tInstalador del sistema EPLAM\t###\n"
echo -e "- Para aceptar las opciones por default (), solamente presione enter.\n"
echo -e "- Todos los directorios deben ser ingresados sin '/' al inicio ni al final ( Ej: midir/misubdir ).\n"
echo -e "- El directorio ingresado sera relativo a: $GRUPO\n\n"
## Request exec directory
DIRBIN=$(request_dirpath "Defina el directorio de Ejecutables ($GRUPO/$DIRBIN): " $DIRBIN)
## Request file directory
DIRMAE=$(request_dirpath "Defina el directorio de Maestros y Tablas ($GRUPO/$DIRMAE): " $DIRMAE)

echo -e "\nDirectorio de Configuracion: $GRUPO/$DIRCONF"
echo -e "Directorio de Ejecutables: $GRUPO/$DIRBIN"
echo -e "Directorio de Maestros y Tablas: $GRUPO/$DIRMAE"

read -p "Desea continuar con la instalacion? ( S / N ): " CONTINUE
done
